import e from"@babel/runtime/helpers/esm/extends";import t,{createContext as n,useContext as i,useMemo as r,useRef as a,useLayoutEffect as s,useState as o,useCallback as l}from"react";import c from"yoga-layout-wasm";import{Group as g}from"react-konva";let d;async function m(e){d=await c.init(e)}const u=e=>e[0].toUpperCase()+e.slice(1),p=e=>e.toUpperCase().replace("-","_"),h=(e,t,n)=>Object.keys(t).forEach((i=>{const r=t[i];if("string"==typeof r)switch(i){case"flexDir":case"dir":case"flexDirection":return e.setFlexDirection(d[`FLEX_DIRECTION_${p(r)}`]);case"align":case"alignItems":return e.setAlignItems(d[`ALIGN_${p(r)}`]);case"justify":case"justifyContent":return e.setJustifyContent(d[`JUSTIFY_${p(r)}`]);case"wrap":case"flexWrap":return e.setFlexWrap(d[`WRAP_${p(r)}`]);case"basis":case"flexBasis":return e.setFlexBasis(r);default:return e[`set${u(i)}`](r)}else if("number"==typeof r){const t=r*n;switch(i){case"basis":case"flexBasis":return e.setFlexBasis(t);case"grow":case"flexGrow":return e.setFlexGrow(t);case"shrink":case"flexShrink":return e.setFlexShrink(t);case"align":return e.setAlignItems(r);case"justify":return e.setJustifyContent(r);case"flexDir":case"dir":return e.setFlexDirection(r);case"wrap":return e.setFlexWrap(r);case"padding":case"p":return e.setPadding(d.EDGE_ALL,t);case"paddingLeft":case"pl":return e.setPadding(d.EDGE_LEFT,t);case"paddingRight":case"pr":return e.setPadding(d.EDGE_RIGHT,t);case"paddingTop":case"pt":return e.setPadding(d.EDGE_TOP,t);case"paddingBottom":case"pb":return e.setPadding(d.EDGE_BOTTOM,t);case"margin":case"m":return e.setMargin(d.EDGE_ALL,t);case"marginLeft":case"ml":return e.setMargin(d.EDGE_LEFT,t);case"marginRight":case"mr":return e.setMargin(d.EDGE_RIGHT,t);case"marginTop":case"mt":return e.setMargin(d.EDGE_TOP,t);case"marginBottom":case"mb":return e.setMargin(d.EDGE_BOTTOM,t);default:return e[`set${u(i)}`](t)}}}));const f=e=>Object.keys(e).forEach((t=>void 0===e[t]?delete e[t]:{})),x=n({scaleFactor:100,requestReflow(){console.warn("Flex not initialized! Please report")},registerBox(){console.warn("Flex not initialized! Please report")},unregisterBox(){console.warn("Flex not initialized! Please report")}}),w=n({node:null,size:[0,0],dirtyId:0});function y(e){let t=i(e);return t||console.warn("You must place this hook/component under a <Flex/> component!"),t}function E(){const{requestReflow:e}=y(x);return e}function b(){const{size:e}=y(w);return e}function C(n){let{children:i,centerAnchor:l,flexDirection:c,flexDir:m,dir:u,alignContent:p,alignItems:b,alignSelf:C,align:D,justifyContent:T,justify:B,flexBasis:I,basis:R,flexGrow:L,grow:F,flexShrink:G,shrink:W,flexWrap:_,wrap:k,margin:O,m:P,marginBottom:H,marginLeft:v,marginRight:N,marginTop:j,mb:M,ml:A,mr:S,mt:z,padding:$,p:Y,paddingBottom:q,paddingLeft:J,paddingRight:U,paddingTop:X,pb:K,pl:Q,pr:V,pt:Z,height:ee,width:te,maxHeight:ne,maxWidth:ie,minHeight:re,minWidth:ae,...se}=n;const oe=r((()=>{const e={flexDirection:c,flexDir:m,dir:u,alignContent:p,alignItems:b,alignSelf:C,align:D,justifyContent:T,justify:B,flexBasis:I,basis:R,flexGrow:L,grow:F,flexShrink:G,shrink:W,flexWrap:_,wrap:k,margin:O,m:P,marginBottom:H,marginLeft:v,marginRight:N,marginTop:j,mb:M,ml:A,mr:S,mt:z,padding:$,p:Y,paddingBottom:q,paddingLeft:J,paddingRight:U,paddingTop:X,pb:K,pl:Q,pr:V,pt:Z,height:ee,width:te,maxHeight:ne,maxWidth:ie,minHeight:re,minWidth:ae};return f(e),e}),[D,p,b,C,u,I,R,m,c,L,F,G,W,_,ee,B,T,P,O,H,v,N,j,ne,ie,M,re,ae,A,S,z,Y,$,q,J,U,X,K,Q,V,Z,te,k]),{registerBox:le,unregisterBox:ce,scaleFactor:ge}=y(x),{node:de,dirtyId:me}=y(w),ue=a(null),pe=r((()=>d.Node.create()),[]),he=E();s((()=>{h(pe,oe,ge)}),[oe,pe,ge]),s((()=>{if(ue.current&&de)return de.insertChild(pe,de.getChildCount()),le(pe,ue.current,oe,l),()=>{de.removeChild(pe),ce(pe)}}),[pe,de,oe,l,me,le,ce]),s((()=>{he()}),[i,oe,me,he]);const[fe,xe]=o([0,0]),we=1/ge;s((()=>{const e=("number"==typeof oe.width?oe.width:null)||pe.getComputedWidth().valueOf()/ge,t=("number"==typeof oe.height?oe.height:null)||pe.getComputedHeight().valueOf()/ge;(Math.abs(e-fe[0])>we||Math.abs(t-fe[1])>we)&&xe([e,t])}),[we,oe.height,oe.width,pe,ge,fe]);const ye=r((()=>({node:pe,size:fe,dirtyId:me})),[pe,fe,me]);return t.createElement(g,e({ref:ue},se),t.createElement(w.Provider,{value:ye},"function"==typeof i?i(fe[0],fe[1]):i))}function D(e){let{size:n=[1,1,1],yogaDirection:i="ltr",plane:c="xy",children:m,scaleFactor:u=100,onReflow:p,flexDirection:y,flexDir:E,dir:b,alignContent:C,alignItems:D,alignSelf:T,align:B,justifyContent:I,justify:R,flexBasis:L,basis:F,flexGrow:G,grow:W,flexShrink:_,shrink:k,flexWrap:O,wrap:P,margin:H,m:v,marginBottom:N,marginLeft:j,marginRight:M,marginTop:A,mb:S,ml:z,mr:$,mt:Y,padding:q,p:J,paddingBottom:U,paddingLeft:X,paddingRight:K,paddingTop:Q,pb:V,pl:Z,pr:ee,pt:te,height:ne,width:ie,maxHeight:re,maxWidth:ae,minHeight:se,minWidth:oe,...le}=e;const ce=r((()=>{const e={flexDirection:y,flexDir:E,dir:b,alignContent:C,alignItems:D,alignSelf:T,align:B,justifyContent:I,justify:R,flexBasis:L,basis:F,flexGrow:G,grow:W,flexShrink:_,shrink:k,flexWrap:O,wrap:P,margin:H,m:v,marginBottom:N,marginLeft:j,marginRight:M,marginTop:A,mb:S,ml:z,mr:$,mt:Y,padding:q,p:J,paddingBottom:U,paddingLeft:X,paddingRight:K,paddingTop:Q,pb:V,pl:Z,pr:ee,pt:te,height:ne,width:ie,maxHeight:re,maxWidth:ae,minHeight:se,minWidth:oe};return f(e),e}),[B,C,D,T,b,L,F,E,y,G,W,_,k,O,ne,R,I,v,H,N,j,M,A,re,ae,S,se,oe,z,$,Y,J,q,U,X,K,Q,V,Z,ee,te,ie,P]),ge=a([]),de=l((function(e,t,n,i){void 0===i&&(i=!1);const r=ge.current.findIndex((t=>t.node===e));-1!==r&&ge.current.splice(r,1),ge.current.push({group:t,node:e,flexProps:n,centerAnchor:i})}),[]),me=l((e=>{const t=ge.current.findIndex((t=>t.node===e));-1!==t&&ge.current.splice(t,1)}),[]),ue=r((()=>d.Node.create()),[]);s((()=>{h(ue,ce,u)}),[ue,ce,u]);const[pe,he]=o(0),fe=l((()=>{}),[]),xe=a(0),we=a(!1);s((()=>{we.current=!1,xe.current+=1}));const ye=l((()=>{we.current||(we.current=!0,he((e=>e+1)),fe())}),[fe]);s((()=>{ye()}),[m,ce,ye]);const[Ee,be]=function(e,t){switch(t){case"xy":return[e[0],e[1]];case"yz":return[e[1],e[2]];case"xz":return[e[0],e[2]]}}(n,c),Ce="ltr"===i?d.DIRECTION_LTR:"rtl"===i?d.DIRECTION_RTL:i,De=r((()=>({requestReflow:ye,registerBox:de,unregisterBox:me,scaleFactor:u})),[ye,de,me,u]),Te=r((()=>({node:ue,size:[Ee,be],dirtyId:pe})),[ue,Ee,be,pe]);return s((()=>{!function(){const e=Array(ge.current.length);ge.current.forEach(((t,n)=>{let{group:i,node:r,flexProps:a}=t;const s="number"==typeof a.width?a.width*u:a.width,o="number"==typeof a.height?a.height*u:a.height;if(void 0!==s&&void 0!==o)r.setWidth(s),r.setHeight(o);else if(0===r.getChildCount()){const t=i.getClientRect({skipTransform:!0});e[n]=t,r.setWidth(s||t.width*u),r.setHeight(o||t.height*u)}else console.log("HEY NAN",r,i,a),r.setWidth(NaN),r.setHeight(NaN)})),console.log("YOGA NODE",ue.getChildCount()),ue.calculateLayout(Ee*u,be*u,Ce);let t=0,n=0,i=0,r=0;ge.current.forEach(((a,s)=>{let{group:o,node:l,centerAnchor:c}=a;const{left:g,top:d,width:m,height:p}=l.getComputedLayout();let h=0,f=0;const x=e[s];x?(h=x.x,f=x.y):console.log("NO bb for index",s);const w={x:(g+(c?m/2:0))/u,y:(d+(c?p/2:0))/u};w.x-=h,w.y-=f,t=Math.min(t,g),i=Math.min(i,d),n=Math.max(n,g+m),r=Math.max(r,d+p),o.position(w)})),p&&p((n-t)/u,(r-i)/u)}()}),[pe]),t.createElement(g,le,t.createElement(x.Provider,{value:De},t.createElement(w.Provider,{value:Te},m)))}export{C as Box,D as Flex,m as initKonvaFlex,y as useContext,b as useFlexSize,E as useReflow};
